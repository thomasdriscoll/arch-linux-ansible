---
- name: Set up LVM with dm-crypt
  hosts: localhost
  gather_facts: true
  become: yes

  vars_files:
    - vars.yml

  tasks:
    - name: Gather disk facts
      setup:

    - name: initialize empty list for devices
      set_fact:
        storage_devices: []
      no_log: true

    - name: get SATA and NVMe devices
      set_fact:
        storage_devices: "{{ storage_devices + ['/dev/' + item.key] }}"
      no_log: true
      with_dict: "{{ ansible_facts.devices }}"
      when: "item.value.host.startswith('SATA controller:') or
             item.value.host.startswith('Non-Volatile memory controller:')"

    - name: Create boot partition
      parted:
        device: "{{ item }}"
        number: 1
        state: present
        part_end: "{{ boot_partition_size }}"
        part_start: 1MiB
      loop: "{{ storage_devices }}"
      register: partitions
      changed_when: true

    - name: Create partition on boot disk
      parted:
        device: "{{ item }}"
        number: 2
        state: present
        part_end: "100%"
        part_start: "{{ boot_partition_size }}"
      loop: "{{ storage_devices }}"
      register: partitions
      changed_when: true

    - name: Create remaining partitions
      parted:
        device: "{{ item }}"
        number: 1
        state: present
        part_end: "100%"
        part_start: 1MiB
      loop: "{{ storage_devices }}"
      when: loop.index > 0
      register: partitions
      changed_when: true

    - name: Show partition details
      debug:
        var: partitions

    - name: Create physical volumes
      command: pvcreate "{{ item }}"
      become: true
      become_user: root
      loop: "{{ partitions }}"
      when: loop.index > 0
      register: pvcreate_output

    - name: Extract physical volume names
      set_fact:
        vg_physical_volumes: "{{ pvcreate_output.results | map(attribute='cmd.args') | list }}"

    - name: Create volume group
      lvg:
        vg: "{{ vg_name }}"
        pvs: "{{ vg_physical_volumes }}"
      become: true
      become_user: root

    - name: Create logical volume for root
      # Create a logical volume within the volume group
      lvol:
        vg: "{{ vg_name }}"
        lv: "{{ item.name }}"
        size: "{{ item.size }}"
      with_items:
        - { name: "{{ root_lv }}", size: "{{ root_lv_size }}" }
        - { name: "{{ swap_lv }}", size: "{{ swap_lv_size }}" }
        - { name: "{{ tmp_lv }}", size: "{{ tmp_lv_size }}" }
        - { name: "{{ home_lv }}", size: "{{ home_lv_size }}" }

    - name: Set up and open dm-crypt on logical volume
      community.crypto.luks_device:
        name: "{{ root_crypt_name }}"
        state: opened
        device: "/dev/{{ vg_name }}/{{ root_lv }}"
        cipher: aes-xts-plain64
        passphrase: "{{ passphrase }}"
      become: true
      become_user: root

    - name: Create encrypted filesystem
      # Create a filesystem on the encrypted volume
      filesystem:
        fstype: ext4  # Replace with the desired filesystem type (e.g., ext4, xfs, etc.)
        dev: "{{ root_device }}"

    - name: Zero out the boot partition
      command: dd if=/dev/zero of="{{ item.device }}" bs=1M count=299 status=progress
      become: true
      become_user: root
      loop: "{{ partitions }}"
      when: loop.index == 0

    - name: Format partition as FAT32
      command: mkfs.fat -F32 "{{ item.device }}"
      become: true
      become_user: root
      loop: "{{ partitions }}"
      when: loop.index == 0

    - name: run reflector
      ansible.builtin.shell: reflector --country us --age 12 --protocol https --sort rate --save /etc/pacman.d/mirrorlist
      become: true
      become_user: root

### mounting
    - name: mount encrypted filesystem
      # mount the encrypted filesystem to the specified mount path
      mount:
        path: /mnt  # replace with the desired mount path
        src: "{{ root_device }}"
        fstype: ext4  # replace with the desired filesystem type
        state: mounted

    - name: create mount point
      file:
        path: /mnt/boot
        state: directory
      become: true
      become_user: root

    - name: Mount boot partition
      mount:
        path: /mnt/boot
        src: "{{ item.device }}"
        fstype: vfat
        state: mounted
      loop: "{{ partitions }}"
      when: loop.index == 0
      become: true
      become_user: root

    - name: Determine microcode update package
      set_fact:
        microcode_package: "{{ 'intel-ucode' if ansible_processor[0] == 'Intel' else 'amd-ucode' }}"

    - name: Install packages using pacstrap
      ansible.builtin.command: pacstrap /mnt {{ item }}
      with_items:
        - base
        - linux
        - linux-firmware
        - networkmanager
        - neovim
        - vim
        - git
        - sudo
        - lvm2
        - iwd
        - efibootmgr
        - "{{ microcode_package }}"
      become: true
      become_user: root

    - name: generate fstab
      ansible.builtin.template:
        src: templates/fstab.j2
        dest: /mnt/etc/fstab

    - name: generate crypttab
      ansible.builtin.template:
        src: templates/crypttab.j2
        dest: /mnt/etc/crypttab

    - name: Set time zone
      command: ln -sf /mnt/usr/share/zoneinfo/America/Chicago /mnt/etc/localtime
      become: true
      become_user: root

    - name: Adjust hwclock
      command: hwclock --systohc
      become: true
      become_user: root

    - name: Uncomment localegen language
      ansible.builtin.lineinfile:
        path: /mnt/etc/locale.gen
        regexp: '^#?(.*en_US\.UTF-8 UTF-8.*)$'
        line: 'en_US.UTF-8 UTF-8'
      become: true
      become_user: root

    - name: Generate locales
      command: arch-chroot /mnt locale-gen
      become: true
      become_user: root

    - name: Create locale.conf
      copy:
        content: "LANG=en_US.UTF-8"
        dest: /mnt/etc/locale.conf
      become: true
      become_user: root

    - name: Set keyboard layout
      copy:
        content: "KEYMAP=us\nXKBLAYOUT=us"
        dest: /mnt/etc/vconsole.conf
      become: true
      become_user: root

    - name: Create hostname
      copy:
        content: "{{ network_name }}"
        dest: /mnt/etc/hostname
      become: true
      become_user: root

    - name: configure mkinitcpio
      lineinfile:
        path: "/mnt/etc/mkinitcpio.conf"
        regexp: "^hooks=(.*)"
        line: 'hooks="{{ item.hooks }}"'
      with_items:
        - { hooks: "base systemd autodetect modconf kms keyboard sd-vconsole block sd-encrypt lvm2 filesystems fsck" }
      become: true
      become_user: root

    - name: Run mkinitcpio
      command: arch-chroot /mnt mkinitcpio -P
      become: true
      become_user: root
    # Additional tasks can be added for further configuration or customization

