---
- name: Set up LVM with dm-crypt
  hosts: localhost
  become: yes

  vars_files:
    - vars.yml

  tasks:
    - name: Create partitions
      parted:
        device: /dev/sda
        number: "{{ item.number }}"
        state: present
        part_end: "{{ item.part_end }}"
        part_start: "{{ item.part_start }}"
      with_items:
        - { number: 1, part_start: 1MiB, part_end: 300MiB }
        - { number: 2, part_start: 300MiB, part_end: "100%" }
      become: true
      become_user: root

    - name: Create physical volume
      # Create a physical volume on the specified disk
      command: pvcreate "{{ main_part }}"
      become: true
      become_user: root

    - name: Create volume group
      # Create a volume group using the physical volume
      lvg:
        vg: "{{ vg_name }}"
        pvs: "{{ main_part }}"

    - name: Create logical volume for root
      # Create a logical volume within the volume group
      lvol:
        vg: "{{ vg_name }}"
        lv: "{{ item.name }}"
        size: "{{ item.size }}"
      with_items:
        - { name: "{{ root_lv }}", size: "{{ root_lv_size }}" }
        - { name: "{{ swap_lv }}", size: "{{ swap_lv_size }}" }
        - { name: "{{ tmp_lv }}", size: "{{ tmp_lv_size }}" }
        - { name: "{{ home_lv }}", size: "{{ home_lv_size }}" }

    - name: Set up and open dm-crypt on logical volume
      community.crypto.luks_device:
        name: "{{ root_crypt_name }}"
        state: opened
        device: "/dev/{{ vg_name }}/{{ root_lv }}"
        cipher: aes-xts-plain64
        passphrase: "{{ passphrase }}"
      become: true
      become_user: root

    - name: Create encrypted filesystem
      # Create a filesystem on the encrypted volume
      filesystem:
        fstype: ext4  # Replace with the desired filesystem type (e.g., ext4, xfs, etc.)
        dev: "/dev/mapper/{{ root_crypt_name }}"

    - name: Zero out the boot partition
      command: dd if=/dev/zero of=/dev/sda1 bs=1M count=299 status=progress
      become: true
      become_user: root

    - name: Format partition as fat32
      command: mkfs.fat -F32 /dev/sda1
      become: true
      become_user: root

    - name: run reflector
      ansible.builtin.shell: reflector --country us --age 12 --protocol https --sort rate --save /etc/pacman.d/mirrorlist
      become: true
      become_user: root

### mounting
    - name: mount encrypted filesystem
      # mount the encrypted filesystem to the specified mount path
      mount:
        path: /mnt  # replace with the desired mount path
        src: "/dev/mapper/{{ root_crypt_name }}"
        fstype: ext4  # replace with the desired filesystem type
        state: mounted

    - name: create mount point
      file:
        path: /mnt/boot
        state: directory
      become: true
      become_user: root

    - name: mount boot partition
      mount:
        path: /mnt/boot
        src: /dev/sda1
        fstype: vfat
        state: mounted
      become: true
      become_user: root

    - name: run pacstrap
      ansible.builtin.command: pacstrap /mnt base linux linux-firmware networkmanager neovim vim git sudo lvm2 iwd efibootmgr intel-ucode
      become: true
      become_user: root

    - name: generate fstab
      shell: genfstab -U /mnt >> /mnt/etc/fstab
      become: true
      become_user: root

    - name: Set time zone
      command: ln -sf /mnt/usr/share/zoneinfo/America/Chicago /mnt/etc/localtime
      become: true
      become_user: root

    - name: Adjust hwclock
      command: hwclock --systohc
      become: true
      become_user: root

    - name: Uncomment localegen language
      ansible.builtin.lineinfile:
        path: /mnt/etc/locale.gen
        regexp: '^#?(.*en_US\.UTF-8 UTF-8.*)$'
        line: 'en_US.UTF-8 UTF-8'
      become: true
      become_user: root

    - name: Generate locales
      command: arch-chroot /mnt locale-gen
      become: true
      become_user: root

    - name: Create locale.conf
      copy:
        content: "LANG=en_US.UTF-8"
        dest: /mnt/etc/locale.conf
      become: true
      become_user: root

    - name: Set keyboard layout
      copy:
        content: "KEYMAP=us\nXKBLAYOUT=us"
        dest: /mnt/etc/vconsole.conf
      become: true
      become_user: root

    - name: Create hostname
      copy:
        content: " {{ network_name }} "
        dest: /mnt/etc/hostname
      become: true
      become_user: root

    - name: configure mkinitcpio
      lineinfile:
        path: "/mnt/etc/mkinitcpio.conf"
        regexp: "^hooks=(.*)"
        line: 'hooks="{{ item.hooks }}"'
      with_items:
        - { hooks: "base systemd autodetect modconf kms keyboard sd-vconsole block sd-encrypt lvm2 filesystems fsck" }
      become: true
      become_user: root

    - name: Run mkinitcpio
      command: arch-chroot /mnt mkinitcpio -P
      become: true
      become_user: root
    # Additional tasks can be added for further configuration or customization

